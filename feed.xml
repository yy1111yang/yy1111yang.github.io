<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Azure Cloud Blog</title>
    <link>https://yy1111yang.github.io/</link>
    
    <atom:link href="https://yy1111yang.github.io/feed.xml" rel="self" type="application/rss+xml"/>
    
    <description>Azure Cloud Blog</description>
    <pubDate>Tue, 27 Jun 2023 06:56:54 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>Azure app architecure - step05</title>
      <link>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app05/</link>
      <guid>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app05/</guid>
      <pubDate>Sat, 19 Dec 2020 18:54:09 GMT</pubDate>
      
        
        
      <description>&lt;h3 id=&quot;deploy-Vue-js-to-Azure-Static-Web&quot;&gt;&lt;a href=&quot;#deploy-Vue-js-to-Azure-Static-Web&quot; class=&quot;headerlink&quot; title=&quot;deploy Vue.js to Azure Sta</description>
        
      
      
      
      <content:encoded><![CDATA[<h3 id="deploy-Vue-js-to-Azure-Static-Web"><a href="#deploy-Vue-js-to-Azure-Static-Web" class="headerlink" title="deploy Vue.js to Azure Static Web."></a>deploy Vue.js to Azure Static Web.</h3><img src="/2020/12/19/20201220-azure-sample-app05/02.step05.png" class=""><p><strong>Create empty azure storage account.</strong></p><img src="/2020/12/19/20201220-azure-sample-app05/01.create_storage.png" class=""><p><strong>Enable Static Web Site</strong></p><img src="/2020/12/19/20201220-azure-sample-app05/02.set_web_static.png" class=""><p><strong>Get Endpoint URL</strong></p><img src="/2020/12/19/20201220-azure-sample-app05/03.get_endpoint.png" class=""><p><strong>Build Vue project</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure><p>After build, create <code>\dist</code> folder.<br>And we move this folder to $web container in storage account.</p><p>We can use <strong>Storage Explorer</strong>.<br><a href="https://azure.microsoft.com/ko-kr/features/storage-explorer/">Storage Explorer Download</a></p><p>After install Explorer, connect your storage before you created.<br>Then move <strong>Blob container &gt; $web</strong></p><img src="/2020/12/19/20201220-azure-sample-app05/04.storage_explorer.png" class=""><p>And  <strong>drag and drop</strong> all files in build path <code>dist\</code> to right panel.</p><img src="/2020/12/19/20201220-azure-sample-app05/05.storage_explorer_02.png" class=""><p>Then open the browser, then move the endpoint at storage static web.<br>But when we click the button <strong>Search User</strong>, we return <strong>error message about CORS.</strong></p><img src="/2020/12/19/20201220-azure-sample-app05/06.test_web.png" class=""><p>So, we added web endpoint in Azure Function.</p><img src="/2020/12/19/20201220-azure-sample-app05/07.add_cors.png" class=""><p><strong>Finall, we connect successfully.</strong></p><img src="/2020/12/19/20201220-azure-sample-app05/08.test_success.png" class=""><p><strong>Thanks</strong></p><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3><a href="/2020/12/19/20201220-azure-sample-app/" title="Azure app architecure - Summary">Azure app architecure - Summary</a> <br><a href="/2020/12/19/20201220-azure-sample-app01/" title="Azure app architecure - step01">Azure app architecure - step01</a> <br>  <a href="/2020/12/19/20201220-azure-sample-app02/" title="Azure app architecure - step02">Azure app architecure - step02</a> <br><a href="/2020/12/19/20201220-azure-sample-app03/" title="Azure app architecure - step03">Azure app architecure - step03</a> <br><a href="/2020/12/19/20201220-azure-sample-app04/" title="Azure app architecure - step04">Azure app architecure - step04</a>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Function/">Function</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/StaticWeb/">StaticWeb</category>
      
      <category domain="https://yy1111yang.github.io/tags/Function/">Function</category>
      
      <category domain="https://yy1111yang.github.io/tags/Cosmos/">Cosmos</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app05/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure app architecure - step04</title>
      <link>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app04/</link>
      <guid>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app04/</guid>
      <pubDate>Sat, 19 Dec 2020 18:54:03 GMT</pubDate>
      
        
        
      <description>&lt;h3 id=&quot;create-Vue-js-in-local&quot;&gt;&lt;a href=&quot;#create-Vue-js-in-local&quot; class=&quot;headerlink&quot; title=&quot;create Vue.js in local.&quot;&gt;&lt;/a&gt;create Vue.js in lo</description>
        
      
      
      
      <content:encoded><![CDATA[<h3 id="create-Vue-js-in-local"><a href="#create-Vue-js-in-local" class="headerlink" title="create Vue.js in local."></a>create Vue.js in local.</h3><img src="/2020/12/19/20201220-azure-sample-app04/02.step04.png" class=""><p><strong>Install</strong> vue-cli using cmd.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install @vue/cli -g</span><br><span class="line">npm i -g @vue/cli-init</span><br></pre></td></tr></table></figure><p>Create <strong>Vue-Project</strong> using vue-cli.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue init webpack user-frontend</span><br></pre></td></tr></table></figure><p>And enter value you want.<br>I enter defalult vaules.</p><p>After created project, execute vue project using cmd.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> user-frontend</span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure><img src="/2020/12/19/20201220-azure-sample-app04/01.test_default_screen.png" class=""><p><strong>Add axios Module</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install axios@<span class="number">0</span>.<span class="number">21</span>.<span class="number">0</span> --save</span><br></pre></td></tr></table></figure><p>And change code in <code>src\main.js</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span><span class="comment">// import axios</span></span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span></span><br><span class="line">Vue.prototype.axios = axios <span class="comment">// configure axios</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App),</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure><p>And remove the code <code>&lt;img src=&quot;./assets/logo.png&quot;&gt;</code> in <code>src/App.vue</code> for remove img.</p><p>And change the code in <code>src\components\HelloWorld.vue</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;button v-on:click&#x3D;&quot;findUser&quot;&gt;Search User&lt;&#x2F;button&gt;</span><br><span class="line">    &lt;div id&#x3D;&quot;example&quot;&gt;</span><br><span class="line">        &lt;table id&#x3D;&quot;userList&quot;&gt;</span><br><span class="line">            &lt;thead&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;th&gt;Name&lt;&#x2F;th&gt;</span><br><span class="line">                    &lt;th&gt;Age&lt;&#x2F;th&gt;</span><br><span class="line">                    &lt;th&gt;Sex&lt;&#x2F;th&gt;</span><br><span class="line">                &lt;&#x2F;tr&gt;</span><br><span class="line">            &lt;&#x2F;thead&gt;</span><br><span class="line">            &lt;tbody id&#x3D;&quot;contacts&quot;&gt;</span><br><span class="line">                &lt;tr v-for&#x3D;&quot;user in users&quot; v-bind:key&#x3D;&quot;user.name&quot;&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123;user.name&#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123;user.age&#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">                    &lt;td&gt;&#123;&#123;user.sex&#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">                &lt;&#x2F;tr&gt;</span><br><span class="line">            &lt;&#x2F;tbody&gt;</span><br><span class="line">        &lt;&#x2F;table&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#39;app&#39;,</span><br><span class="line">  data: function () &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      users: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    findUser: function () &#123;</span><br><span class="line">      &#x2F;&#x2F;const baseURI &#x3D; &#39;http:&#x2F;&#x2F;localhost:7071&#x2F;api&#39;;</span><br><span class="line">      const baseURI &#x3D; &lt;function endpoint&gt; &#x2F;&#x2F; change user URL</span><br><span class="line">      this.axios.get(&#96;$&#123;baseURI&#125;&#x2F;find-user&#96;)</span><br><span class="line">      .then((result) &#x3D;&gt; &#123;</span><br><span class="line">        this.users &#x3D; result.data</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Add &quot;scoped&quot; attribute to limit CSS to this component only --&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">#app &#123;</span><br><span class="line">  font-family: &#39;Avenir&#39;, Helvetica, Arial, sans-serif;</span><br><span class="line">  -webkit-font-smoothing: antialiased;</span><br><span class="line">  -moz-osx-font-smoothing: grayscale;</span><br><span class="line">  color: #2c3e50;</span><br><span class="line">  max-width: 560px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure><p>And retry exectue vue server.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev</span><br></pre></td></tr></table></figure><p>We find changed screen like this.<br>Then if we click button named <strong>Search User</strong>, <strong>occur error</strong> like this.</p><img src="/2020/12/19/20201220-azure-sample-app04/02.change_screen.png" class=""><p>To solve this problem, you enable CORS in Azure Function in portal.<br><strong>Enable Access-control-Allow-Credential</strong><br><strong>Add localhost:8080</strong><br>Then save.</p><img src="/2020/12/19/20201220-azure-sample-app04/03.enable_cors.png" class=""><p>After change, we retry click button, then we return data successfully.</p><img src="/2020/12/19/20201220-azure-sample-app04/04.get_result.png" class=""><p><strong>We finish make a simple vue project in local.</strong></p><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3><a href="/2020/12/19/20201220-azure-sample-app/" title="Azure app architecure - Summary">Azure app architecure - Summary</a> <br><a href="/2020/12/19/20201220-azure-sample-app01/" title="Azure app architecure - step01">Azure app architecure - step01</a> <br>  <a href="/2020/12/19/20201220-azure-sample-app02/" title="Azure app architecure - step02">Azure app architecure - step02</a> <br><a href="/2020/12/19/20201220-azure-sample-app03/" title="Azure app architecure - step03">Azure app architecure - step03</a> <br><a href="/2020/12/19/20201220-azure-sample-app05/" title="Azure app architecure - step05">Azure app architecure - step05</a>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Function/">Function</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/StaticWeb/">StaticWeb</category>
      
      <category domain="https://yy1111yang.github.io/tags/Function/">Function</category>
      
      <category domain="https://yy1111yang.github.io/tags/Cosmos/">Cosmos</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app04/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure app architecure - step03</title>
      <link>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app03/</link>
      <guid>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app03/</guid>
      <pubDate>Sat, 19 Dec 2020 18:53:55 GMT</pubDate>
      
        
        
      <description>&lt;h3 id=&quot;Deploy-Azure-Function&quot;&gt;&lt;a href=&quot;#Deploy-Azure-Function&quot; class=&quot;headerlink&quot; title=&quot;Deploy Azure Function&quot;&gt;&lt;/a&gt;Deploy Azure Function&lt;/</description>
        
      
      
      
      <content:encoded><![CDATA[<h3 id="Deploy-Azure-Function"><a href="#Deploy-Azure-Function" class="headerlink" title="Deploy Azure Function"></a>Deploy Azure Function</h3><img src="/2020/12/19/20201220-azure-sample-app03/02.step03.png" class=""><p>In Azure Extenstion in VS Code, right click at function you created.<br>Then Click <strong>Deploy to Function App..</strong></p><img src="/2020/12/19/20201220-azure-sample-app03/01.deploy_function.png" class=""><p>Click <strong>Deploy.</strong></p><img src="/2020/12/19/20201220-azure-sample-app03/01.deploy_function_01.png" class=""><p>After a few minutes, we find the function in portal.</p><img src="/2020/12/19/20201220-azure-sample-app03/02.check_deploy_function.png" class=""><p>We also check functions <strong>create-user</strong>, <strong>find-user</strong> in Functions.</p><img src="/2020/12/19/20201220-azure-sample-app03/02.check_deploy_function_01.png" class=""><p>And we get the <strong>endpoint</strong> in each function.<br><strong>Copy the URL.</strong></p><img src="/2020/12/19/20201220-azure-sample-app03/03.get_endpoint.png" class=""><p>And try to test <strong>create-user</strong> using browser.</p><img src="/2020/12/19/20201220-azure-sample-app03/04.test_create_user.png" class=""><p>Also try to test <strong>find-user</strong> using browser.</p><img src="/2020/12/19/20201220-azure-sample-app03/04.test_find_user.png" class=""><p>Two function working well.<br><strong>Deploy is successful.</strong></p><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3><a href="/2020/12/19/20201220-azure-sample-app/" title="Azure app architecure - Summary">Azure app architecure - Summary</a> <br><a href="/2020/12/19/20201220-azure-sample-app01/" title="Azure app architecure - step01">Azure app architecure - step01</a> <br>  <a href="/2020/12/19/20201220-azure-sample-app02/" title="Azure app architecure - step02">Azure app architecure - step02</a> <br><a href="/2020/12/19/20201220-azure-sample-app04/" title="Azure app architecure - step04">Azure app architecure - step04</a> <br><a href="/2020/12/19/20201220-azure-sample-app05/" title="Azure app architecure - step05">Azure app architecure - step05</a>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Function/">Function</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/StaticWeb/">StaticWeb</category>
      
      <category domain="https://yy1111yang.github.io/tags/Function/">Function</category>
      
      <category domain="https://yy1111yang.github.io/tags/Cosmos/">Cosmos</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app03/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure app architecure - step02</title>
      <link>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app02/</link>
      <guid>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app02/</guid>
      <pubDate>Sat, 19 Dec 2020 18:53:47 GMT</pubDate>
      
        
        
      <description>&lt;h3 id=&quot;Make-Azure-Function-in-Local&quot;&gt;&lt;a href=&quot;#Make-Azure-Function-in-Local&quot; class=&quot;headerlink&quot; title=&quot;Make Azure Function in Local&quot;&gt;&lt;/a&gt;Ma</description>
        
      
      
      
      <content:encoded><![CDATA[<h3 id="Make-Azure-Function-in-Local"><a href="#Make-Azure-Function-in-Local" class="headerlink" title="Make Azure Function in Local"></a>Make Azure Function in Local</h3><br><img src="/2020/12/19/20201220-azure-sample-app02/02.step02.png" class=""><p><strong>requirement</strong><br>Install Node.js<br>Install Visual Studio Code.</p><p>Open the VS Code. i set the path <code>C:\dev\blog-backend\</code>.</p><img src="/2020/12/19/20201220-azure-sample-app02/01.vs_code_01.png" class=""><p>Install <strong>Azure Function</strong> in Extension.</p><img src="/2020/12/19/20201220-azure-sample-app02/01.create_function_extension.png" class=""><p>After install, you can show Azure Extension in left bar like picture.<br>And click <strong>Sign in to Azure…</strong> for connect your subscription.</p><img src="/2020/12/19/20201220-azure-sample-app02/01.sign_in_azure.png" class=""><p>After Auth, i connected my subscription.</p><img src="/2020/12/19/20201220-azure-sample-app02/02.connect_azure.png" class=""><p>And Right Click, Click <strong>Create Function App in Azure</strong><br>Then type name you want. i named <strong>user-blog_backend</strong><br>and select language <strong>node.js 12</strong></p><img src="/2020/12/19/20201220-azure-sample-app02/03.create_function_app.png" class=""><br>After a few minute, we check function app created under the picture.<img src="/2020/12/19/20201220-azure-sample-app02/04.show_function.png" class=""><p>And select Azure function you created, Click icon <strong>Lightning</strong>.<br>And select <strong>javascript</strong>, <strong>HTTP trigger</strong>.<br>Type the name you want. i named <strong>create-user</strong>.<br>Then select <strong>anonymous</strong>.<br>Finally, create default code like this picture.</p><img src="/2020/12/19/20201220-azure-sample-app02/05.create_function.png" class=""><p>We execute this code using press <strong>F5</strong>.</p><img src="/2020/12/19/20201220-azure-sample-app02/06.show_default_code.png" class=""><p>tTen logging <strong>endpoint</strong> in terminal.</p><img src="/2020/12/19/20201220-azure-sample-app02/07.function_execute.png" class=""><p>I try <strong>GET</strong> method using browser. it’s working well.</p><img src="/2020/12/19/20201220-azure-sample-app02/07.function_execute_02.png" class=""><p><strong>And we change code, add file.</strong><br><code>create-user/index.js</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; async function (context, req) &#123;</span><br><span class="line">    var mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">    var User &#x3D; require(&#39;..&#x2F;model&#x2F;user_model.js&#39;);</span><br><span class="line">    var CONF &#x3D; require(&#39;..&#x2F;Config.js&#39;);</span><br><span class="line"></span><br><span class="line">    mongoose.connect(&quot;mongodb:&#x2F;&#x2F;&quot;+CONF.COSMOSDB_HOST+&quot;:&quot;+CONF.COSMOSDB_PORT+&quot;&#x2F;&quot;+CONF.COSMOSDB_DBNAME+&quot;?ssl&#x3D;true&amp;replicaSet&#x3D;globaldb&quot;, &#123;</span><br><span class="line">        auth: &#123;</span><br><span class="line">            user: CONF.COSMOSDB_USER,</span><br><span class="line">            password: CONF.COSMOSDB_PASSWORD</span><br><span class="line">        &#125;,</span><br><span class="line">        useNewUrlParser: true,</span><br><span class="line">        useUnifiedTopology: true,</span><br><span class="line">        retryWrites: false</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(() &#x3D;&gt; console.log(&#39;Connection to CosmosDB successful&#39;))</span><br><span class="line">    .catch((err) &#x3D;&gt; console.error(err));</span><br><span class="line"></span><br><span class="line">    const user &#x3D; new User(&#123;</span><br><span class="line">        name: req.query.name,</span><br><span class="line">        age: req.query.age,</span><br><span class="line">        sex: req.query.sex</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    context.res &#x3D; &#123;</span><br><span class="line">        &#x2F;&#x2F; status: 200, &#x2F;* Defaults to 200 *&#x2F;</span><br><span class="line">        body: await user.save()</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Create folder and file <code>model/user_model.js</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">var Schema &#x3D; mongoose.Schema;</span><br><span class="line"></span><br><span class="line">const User &#x3D; new mongoose.Schema(&#123;</span><br><span class="line">    name: String,</span><br><span class="line">    age: Number,</span><br><span class="line">    sex: String</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">module.exports &#x3D; mongoose.model(&#39;User&#39;, User);</span><br></pre></td></tr></table></figure><p>Create file <code>Config.js</code> in root path.<br>You need to refer cosmosDB connection_string in portal.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">    COSMOSDB_USER : &lt;cosmos_user_name&gt;,</span><br><span class="line">    COSMOSDB_PASSWORD : &lt;cosmos_password&gt;,    </span><br><span class="line">    COSMOSDB_DBNAME : &quot;user&quot;, # we create database before</span><br><span class="line">    COSMOSDB_HOST : &lt;cosmos_host_name&gt;,</span><br><span class="line">    COSMOSDB_PORT : 10255</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/12/19/20201220-azure-sample-app02/08.cosmos_connection_string.png" class=""><p>And we add <strong>mongoose</strong> module.<br>Execute cmd in terminal.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mongoose@<span class="number">5</span>.<span class="number">11</span>.<span class="number">8</span> --save</span><br></pre></td></tr></table></figure><p>After install well, execute function press <strong>F5</strong> in <strong>index.js</strong>.<br>And test the function like this.</p><img src="/2020/12/19/20201220-azure-sample-app02/09.create_user_test.png" class=""><p>And we check the result in portal.</p><img src="/2020/12/19/20201220-azure-sample-app02/09.create_user_test_02.png" class=""><p>And i made two data <code>test02</code>, <code>test03</code> using exeucte API .</p><h3 id="get-user-data"><a href="#get-user-data" class="headerlink" title="get user data"></a>get user data</h3><p>We create additional function named find-user.<br>and change code<br><code>find-user\index.js</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; async function (context, req) &#123;</span><br><span class="line">    var mongoose &#x3D; require(&#39;mongoose&#39;);</span><br><span class="line">    var User &#x3D; require(&#39;..&#x2F;model&#x2F;user_model.js&#39;);</span><br><span class="line">    var CONF &#x3D; require(&#39;..&#x2F;Config.js&#39;);</span><br><span class="line"></span><br><span class="line">    mongoose.connect(&quot;mongodb:&#x2F;&#x2F;&quot;+CONF.COSMOSDB_HOST+&quot;:&quot;+CONF.COSMOSDB_PORT+&quot;&#x2F;&quot;+CONF.COSMOSDB_DBNAME+&quot;?ssl&#x3D;true&amp;replicaSet&#x3D;globaldb&quot;, &#123;</span><br><span class="line">        auth: &#123;</span><br><span class="line">            user: CONF.COSMOSDB_USER,</span><br><span class="line">            password: CONF.COSMOSDB_PASSWORD</span><br><span class="line">        &#125;,</span><br><span class="line">        useNewUrlParser: true,</span><br><span class="line">        useUnifiedTopology: true,</span><br><span class="line">        retryWrites: false</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(() &#x3D;&gt; console.log(&#39;Connection to CosmosDB successful&#39;))</span><br><span class="line">    .catch((err) &#x3D;&gt; console.error(err));</span><br><span class="line"></span><br><span class="line">    context.res &#x3D; &#123;</span><br><span class="line">        body: await User.find()</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then, <strong>test</strong> the function like this.</p><img src="/2020/12/19/20201220-azure-sample-app02/10.find_user_test.png" class=""><p>We finish make Azure Function App in local.<br><strong>Good job!!</strong></p><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3><a href="/2020/12/19/20201220-azure-sample-app/" title="Azure app architecure - Summary">Azure app architecure - Summary</a> <br><a href="/2020/12/19/20201220-azure-sample-app01/" title="Azure app architecure - step01">Azure app architecure - step01</a> <br>  <a href="/2020/12/19/20201220-azure-sample-app03/" title="Azure app architecure - step03">Azure app architecure - step03</a> <br><a href="/2020/12/19/20201220-azure-sample-app04/" title="Azure app architecure - step04">Azure app architecure - step04</a> <br><a href="/2020/12/19/20201220-azure-sample-app05/" title="Azure app architecure - step05">Azure app architecure - step05</a>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Function/">Function</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/StaticWeb/">StaticWeb</category>
      
      <category domain="https://yy1111yang.github.io/tags/Function/">Function</category>
      
      <category domain="https://yy1111yang.github.io/tags/Cosmos/">Cosmos</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app02/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure app architecure - step01</title>
      <link>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app01/</link>
      <guid>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app01/</guid>
      <pubDate>Sat, 19 Dec 2020 18:53:40 GMT</pubDate>
      
        
        
      <description>&lt;h3 id=&quot;Make-CosmosDB&quot;&gt;&lt;a href=&quot;#Make-CosmosDB&quot; class=&quot;headerlink&quot; title=&quot;Make CosmosDB&quot;&gt;&lt;/a&gt;Make CosmosDB&lt;/h3&gt;&lt;img src=&quot;/2020/12/19/2020122</description>
        
      
      
      
      <content:encoded><![CDATA[<h3 id="Make-CosmosDB"><a href="#Make-CosmosDB" class="headerlink" title="Make CosmosDB"></a>Make CosmosDB</h3><img src="/2020/12/19/20201220-azure-sample-app01/02.step01.png" class=""><p>First, we need to crete <strong>cosmosdb</strong> in portal.<br>Select API : <strong>Cosmos DB for MongoDB API</strong>, Capacity mode: <strong>Serverless</strong><br>then other value set default value.<br>and create resource.</p><img src="/2020/12/19/20201220-azure-sample-app01/01.cosmos_create_01.png" class=""><p>After created DB, you need to go to <strong>Data Explorer</strong> in left bar.<br>And Click <strong>New Database</strong></p><img src="/2020/12/19/20201220-azure-sample-app01/02.database_create.png" class=""><p>Type <strong>User</strong> in text box and create.</p><img src="/2020/12/19/20201220-azure-sample-app01/02.database_create_01.png" class=""><p>And, you can check database created like picture.</p><img src="/2020/12/19/20201220-azure-sample-app01/03.check_database.png" class=""><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3><a href="/2020/12/19/20201220-azure-sample-app/" title="Azure app architecure - Summary">Azure app architecure - Summary</a> <br><a href="/2020/12/19/20201220-azure-sample-app02/" title="Azure app architecure - step02">Azure app architecure - step02</a> <br><a href="/2020/12/19/20201220-azure-sample-app03/" title="Azure app architecure - step03">Azure app architecure - step03</a> <br><a href="/2020/12/19/20201220-azure-sample-app04/" title="Azure app architecure - step04">Azure app architecure - step04</a> <br><a href="/2020/12/19/20201220-azure-sample-app05/" title="Azure app architecure - step05">Azure app architecure - step05</a>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Function/">Function</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/StaticWeb/">StaticWeb</category>
      
      <category domain="https://yy1111yang.github.io/tags/Function/">Function</category>
      
      <category domain="https://yy1111yang.github.io/tags/Cosmos/">Cosmos</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app01/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure app architecure - Summary</title>
      <link>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app/</link>
      <guid>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app/</guid>
      <pubDate>Sat, 19 Dec 2020 18:36:27 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;I recently made a simple application for study.&lt;br&gt;and i share this post.&lt;/p&gt;
&lt;h5 id=&quot;Final-Architecture&quot;&gt;&lt;a href=&quot;#Final-Architecture&quot; c</description>
        
      
      
      
      <content:encoded><![CDATA[<p>I recently made a simple application for study.<br>and i share this post.</p><h5 id="Final-Architecture"><a href="#Final-Architecture" class="headerlink" title="Final Architecture"></a>Final Architecture</h5><img src="/2020/12/19/20201220-azure-sample-app/02.final_arch.png" class=""><hr><p><strong>Price per month at koreacentral.</strong> <a href="https://azure.microsoft.com/en-us/pricing/calculator/">Azure Calculator</a></p><img src="/2020/12/19/20201220-azure-sample-app/01.azure_price.png" class=""><hr><p><strong>There is 5 step</strong></p><img src="/2020/12/19/20201220-azure-sample-app/02.step01.png" class=""><hr><img src="/2020/12/19/20201220-azure-sample-app/02.step02.png" class=""><hr><img src="/2020/12/19/20201220-azure-sample-app/02.step03.png" class=""><hr><img src="/2020/12/19/20201220-azure-sample-app/02.step04.png" class=""><hr><img src="/2020/12/19/20201220-azure-sample-app/02.step05.png" class=""><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3><a href="/2020/12/19/20201220-azure-sample-app01/" title="Azure app architecure - step01">Azure app architecure - step01</a> <br>  <a href="/2020/12/19/20201220-azure-sample-app02/" title="Azure app architecure - step02">Azure app architecure - step02</a> <br><a href="/2020/12/19/20201220-azure-sample-app03/" title="Azure app architecure - step03">Azure app architecure - step03</a> <br><a href="/2020/12/19/20201220-azure-sample-app04/" title="Azure app architecure - step04">Azure app architecure - step04</a> <br><a href="/2020/12/19/20201220-azure-sample-app05/" title="Azure app architecure - step05">Azure app architecure - step05</a>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Function/">Function</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/StaticWeb/">StaticWeb</category>
      
      <category domain="https://yy1111yang.github.io/tags/Function/">Function</category>
      
      <category domain="https://yy1111yang.github.io/tags/Cosmos/">Cosmos</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/19/20201220-azure-sample-app/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Latency Check bentween  Azure VM</title>
      <link>https://yy1111yang.github.io/2020/12/15/20201216-latte-test/</link>
      <guid>https://yy1111yang.github.io/2020/12/15/20201216-latte-test/</guid>
      <pubDate>Tue, 15 Dec 2020 19:30:42 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;This time, Check Latency between Azure VM.&lt;br&gt;And i use &lt;code&gt;latte&lt;/code&gt; for check latency.&lt;br&gt;&lt;a href=&quot;https://gallery.technet.microso</description>
        
      
      
      
      <content:encoded><![CDATA[<p>This time, Check Latency between Azure VM.<br>And i use <code>latte</code> for check latency.<br><a href="https://gallery.technet.microsoft.com/Latte-The-Windows-tool-for-ac33093b">latte download</a></p><p><strong>Ready two virtual machine. one is src VM. Other one is Target VM.</strong></p><img src="/2020/12/15/20201216-latte-test/01.show_vm.png" class=""><p>And Target VM allow firewall about <code>latte</code>.<br>So, execute under command.</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule program=&lt;<span class="built_in">path</span>&gt;\latte.exe name=&quot;Latte&quot; protocol=any <span class="built_in">dir</span>=<span class="keyword">in</span> action=allow enable=yes profile=ANY</span><br><span class="line"></span><br><span class="line">netsh advfirewall firewall add rule program=c:\tools\latte.exe name=&quot;Latte&quot; protocol=any <span class="built_in">dir</span>=<span class="keyword">in</span> action=allow enable=yes profile=ANY</span><br></pre></td></tr></table></figure><img src="/2020/12/15/20201216-latte-test/02.firewall_set.png" class=""><p><strong>Start Latte in Target VM</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">latte -a &lt;Receiver IP address&gt;:&lt;port&gt; -i &lt;iterations&gt;</span><br><span class="line"></span><br><span class="line">latte -a <span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">5</span>:<span class="number">5005</span> -i <span class="number">65100</span></span><br></pre></td></tr></table></figure><p><strong>Execute Command in CMD</strong></p><img src="/2020/12/15/20201216-latte-test/03.target_latte_show.png" class=""><p><strong>Start Latte in Src VM</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">latte -c -a &lt;Receiver IP address&gt;:&lt;port&gt; -i &lt;iterations&gt;</span><br><span class="line"></span><br><span class="line">latte -c -a <span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">5</span>:<span class="number">5005</span> -i <span class="number">65100</span></span><br></pre></td></tr></table></figure><p><strong>Execute Command in CMD</strong><br>We Check latency <code>551.19(usec)</code> between VMs</p><img src="/2020/12/15/20201216-latte-test/04.sender_latte_show.png" class=""><p>And i <strong>enable Network Accelerate.</strong><br>It’s only turn on using CLI not portal. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$list &#x3D; az network nic list | ConvertFrom-Json</span><br><span class="line">foreach($item in $list) &#123;</span><br><span class="line">az network nic update --accelerated-networking true -n $item.name -g $item.resourceGroup --no-wait</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/12/15/20201216-latte-test/05.accelerate_nic.png" class=""><p>Also, We can check value in portal in below.</p><img src="/2020/12/15/20201216-latte-test/05.check_nic.png" class=""><p>And I test latte again.<br>Result <code>Turn on Network Accelerate - 97.36(usec)</code></p><img src="/2020/12/15/20201216-latte-test/06.latte_test_accelerate_nic.png" class=""><p>For more faster, I Create** Proximity_placement_group**</p><img src="/2020/12/15/20201216-latte-test/07.create_proximity.png" class=""><p>Type the name.</p><img src="/2020/12/15/20201216-latte-test/07.create_proximity_02.png" class=""><p>Set Proximity_placement_group in two VM.<br><code>VM &gt; Configuration &gt; Proximity_placement_group</code></p><img src="/2020/12/15/20201216-latte-test/08.set_proximity.png" class=""><p>Result <code>Configure Proximity_Group and Network Accelerate</code></p><img src="/2020/12/15/20201216-latte-test/09.latte_test_proximity.png" class=""><p>And I additional test only configure Proximity_placement_group without network accelerate.</p><img src="/2020/12/15/20201216-latte-test/10.latte_test_only_proximity.png" class=""><p>Then I summary today result belo table. thanks.</p><table><thead><tr><th>Case</th><th align="right">Latency(usec)</th></tr></thead><tbody><tr><td><code>default</code></td><td align="right"><code>551.19</code></td></tr><tr><td><code>NIC Accelerate</code></td><td align="right"><code>97.36</code></td></tr><tr><td><code>Proximity_placement_group</code></td><td align="right"><code>303.51</code></td></tr><tr><td><code>Nic Accelerate + Proximity_placement_group</code></td><td align="right"><code>83.91</code></td></tr></tbody></table><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/">VM</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Network/">Network</category>
      
      <category domain="https://yy1111yang.github.io/tags/Latency/">Latency</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/15/20201216-latte-test/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>How can search NSG flow log easily?</title>
      <link>https://yy1111yang.github.io/2020/12/14/20201215-nsg-visualize/</link>
      <guid>https://yy1111yang.github.io/2020/12/14/20201215-nsg-visualize/</guid>
      <pubDate>Mon, 14 Dec 2020 15:23:51 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;We usually allow, block network flow using NSG in Azure.&lt;br&gt;So, it’s very important to search NSG flow log.&lt;/p&gt;
&lt;p&gt;Today, &lt;strong&gt;we sear</description>
        
      
      
      
      <content:encoded><![CDATA[<p>We usually allow, block network flow using NSG in Azure.<br>So, it’s very important to search NSG flow log.</p><p>Today, <strong>we search NSG using Log analytics and Network Watcher in Azure portal.</strong><br>Before start, you ready one storage account to store NSG flow log.</p><p>Firstly, move the NSG panel, and click the <code>NSG Flow logs</code><br>we know <code>status</code> means log collect status.<br>And <code>traffic Analytics</code> means sending log data to log analytics</p><img src="/2020/12/14/20201215-nsg-visualize/01.show_nsg.png" class=""><p><strong>Then, click the row, and enable Status.</strong><br>I prefer version2, and select storage account to store log data before you crated.<br>Retention 0 means permanent.</p><img src="/2020/12/14/20201215-nsg-visualize/02.flow_setting_01.png" class=""><p>Scroll down, you can see Traffic Analytis Status.<br><strong>Turn on Status also.</strong><br>And select interval. i think 1 hour is too long.</p><img src="/2020/12/14/20201215-nsg-visualize/02.flow_setting_02.png" class=""><p>And then select log analytics workspace.<br>You don’t have it, you can create in here. don’t worry about it.</p><img src="/2020/12/14/20201215-nsg-visualize/03.flow_setting_03.png" class=""><p>Then <code>save</code> the settings.</p><img src="/2020/12/14/20201215-nsg-visualize/03.flow_setting_04.png" class=""><p>Oops. i have a problem like this.<br>I have to solve this problem for save the settings.</p><img src="/2020/12/14/20201215-nsg-visualize/04.flow_error.png" class=""><p>Open additional page in azure portal. then go to the <code>Subscription &gt; Resource Providers</code>.<br>And search <code>Microsoft.insights</code>. it’s not registered… Click <code>Register</code>.</p><img src="/2020/12/14/20201215-nsg-visualize/05.provider_register.png" class=""><p>Check the change the status. good well.!</p><img src="/2020/12/14/20201215-nsg-visualize/05.provider_register_done.png" class=""><p>And try save flow log settings again. it’s good working well.</p><img src="/2020/12/14/20201215-nsg-visualize/06.nsg_flow_done.png" class=""><p>So, it’s turn to search the log. move the network watcher &gt; Traffic Analytics.<br>Initial settings spend about 20,30 minunte like under picture.</p><img src="/2020/12/14/20201215-nsg-visualize/07.show_network_watcher.png" class=""><p>After about 20 min, you can check flow dashboard following picture.<br>it divided inbound, outbound.<br>and divided allow, block.<br>if you wanna search about this, click the bar. then move the query editor.</p><img src="/2020/12/14/20201215-nsg-visualize/08.traffic_dashboard.png" class=""><p>This is query editor. default query is setted automatically for search all row data.</p><img src="/2020/12/14/20201215-nsg-visualize/08.traffic_query_editor.png" class=""><p>I recommend just two additional code under the picture.<br>1, <code>where condition</code> - you can search specific Ip, Port.<br>2, <code>summarized</code> - you can aggregated data easily.</p><img src="/2020/12/14/20201215-nsg-visualize/09.query_result.png" class=""><p>Thanks</p><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/">VM</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/NSG/">NSG</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/NSG/">NSG</category>
      
      <category domain="https://yy1111yang.github.io/tags/Log-Analytics/">Log Analytics</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/14/20201215-nsg-visualize/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>How can i move vm to other subscription.</title>
      <link>https://yy1111yang.github.io/2020/12/14/20201214-az-vm-copy-other-sub/</link>
      <guid>https://yy1111yang.github.io/2020/12/14/20201214-az-vm-copy-other-sub/</guid>
      <pubDate>Mon, 14 Dec 2020 01:21:32 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;Hi. Sometimes we use POC subscription not PROD subscription.&lt;br&gt;Then if you done POC, you move to resources include VM, LB, etc…&lt;br&gt;Maybe</description>
        
      
      
      
      <content:encoded><![CDATA[<p>Hi. Sometimes we use POC subscription not PROD subscription.<br>Then if you done POC, you move to resources include VM, LB, etc…<br>Maybe VM move to another subscription not share tenant too difficult.</p><p>So i try it this post.<br>Total process is following:<br><strong>1. disk to snapshot</strong><br><strong>2. snapshot to VHD in blob</strong><br><strong>3. blob to blob(target Subscription)</strong><br><strong>4. make disk by VHD in blob</strong><br><strong>5. create vm using disk</strong></p><h2 id="Start-Demo"><a href="#Start-Demo" class="headerlink" title="Start Demo"></a>Start Demo</h2><h5 id="1-disk-to-snapshot"><a href="#1-disk-to-snapshot" class="headerlink" title="1. disk to snapshot"></a>1. disk to snapshot</h5><p>I have just one VM having two disk include osdisk.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/01.show_vm_with_disks.png" class=""><p>Before start demo, <strong>we have to create storage account to store vhd.</strong></p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/02.create_storage.png" class=""><p>After created storage, we also create container. i named <code>vmdisk</code></p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/03.create_container.png" class=""><p>And we convert disks to snapshots.<br>If you have many VM, use the command foloowing.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create snapshot </span></span><br><span class="line"></span><br><span class="line"><span class="variable">$resourceGroupName</span> = <span class="string">&#x27;bastion-rg&#x27;</span></span><br><span class="line"><span class="variable">$resourceGroup</span> = <span class="built_in">Get-AzureRmResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$resourceGroupName</span></span><br><span class="line"><span class="variable">$location</span> = <span class="variable">$resourceGroup</span>.Location</span><br><span class="line">  </span><br><span class="line"><span class="variable">$nameList</span> = <span class="selector-tag">@</span>( </span><br><span class="line">   <span class="selector-tag">@</span>&#123; name=<span class="string">&#x27;az204-bastion-vm&#x27;</span>; &#125;</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># create osDisk snapshot</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$list</span> <span class="keyword">in</span> <span class="variable">$nameList</span>) &#123; </span><br><span class="line"><span class="variable">$vmName</span> = <span class="variable">$list</span>.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># get vm information </span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-azvm</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set snapshot configuration</span></span><br><span class="line"><span class="variable">$snapshot</span> =  <span class="built_in">New-AzSnapshotConfig</span> <span class="literal">-SourceUri</span> <span class="variable">$vm</span>.StorageProfile.OsDisk.ManagedDisk.Id  <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-AccountType</span> Premium_LRS  <span class="literal">-CreateOption</span> <span class="built_in">copy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create Snapshot </span></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="string">&#x27;osdisk-&#x27;</span> + <span class="variable">$vmName</span> + <span class="string">&#x27;-001-snapshot&#x27;</span></span><br><span class="line"><span class="built_in">New-AzSnapshot</span> <span class="literal">-Snapshot</span> <span class="variable">$snapshot</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-AsJob</span></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment"># create dataDisk snapshot</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$list</span> <span class="keyword">in</span> <span class="variable">$nameList</span>) &#123; </span><br><span class="line"><span class="variable">$vmName</span> = <span class="variable">$list</span>.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># get vm information </span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">get-azvm</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Name</span> <span class="variable">$vmName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get Disk information</span></span><br><span class="line"><span class="variable">$dataDiskList</span> = <span class="variable">$vm</span>.StorageProfile.DataDisks</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dList</span> <span class="keyword">in</span> <span class="variable">$dataDiskList</span>) &#123; </span><br><span class="line"><span class="variable">$diskName</span> = <span class="variable">$dList</span>.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># if disk is null then continue;</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$diskName</span>) &#123; </span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$disk</span> = <span class="built_in">get-azureRmDisk</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-DiskName</span> <span class="variable">$diskName</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># set snapshot configuration</span></span><br><span class="line"><span class="variable">$snapshot</span> =  <span class="built_in">New-AzSnapshotConfig</span> <span class="literal">-SourceUri</span> <span class="variable">$disk</span>.id <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-AccountType</span> Premium_LRS <span class="literal">-CreateOption</span> <span class="built_in">copy</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$snapshotName</span> = <span class="string">&#x27;datadisk-&#x27;</span> + <span class="variable">$vmName</span> + <span class="string">&#x27;-001-snapshot&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create Snapshot </span></span><br><span class="line"><span class="built_in">New-AzSnapshot</span> <span class="literal">-Snapshot</span> <span class="variable">$snapshot</span> <span class="literal">-SnapshotName</span> <span class="variable">$snapshotName</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-AsJob</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Job</span> | <span class="built_in">Wait-Job</span></span><br><span class="line"><span class="string">&quot;All jobs completed&quot;</span></span><br><span class="line"><span class="built_in">get-azSnapshot</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> | <span class="built_in">format-table</span> Name, ResourceGroupName</span><br></pre></td></tr></table></figure><h5 id="2-snapshot-to-VHD-in-blob"><a href="#2-snapshot-to-VHD-in-blob" class="headerlink" title="2. snapshot to VHD in blob."></a>2. snapshot to VHD in blob.</h5><p>After created snapshots, we should move snapshot to blob container.<br>Use following command.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$storageAccountName</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="variable">$storageContainerName</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="variable">$sasExpiryDuration</span>=<span class="number">3600</span></span><br><span class="line"><span class="variable">$storageAccountKey</span> = <span class="string">&quot; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="variable">$snpashots</span> =  Get-AzSnapshot -resourceGroup &#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">foreach(<span class="variable">$snapshot</span> in <span class="variable">$snpashots</span>) &#123; </span></span><br><span class="line"><span class="string"><span class="variable">$snapshotName</span> = <span class="variable">$snapshot</span>.Name</span></span><br><span class="line"><span class="string"><span class="variable">$destinationVHDFileName</span> = <span class="variable">$snapshotName</span> + &#x27;.vhd&#x27;</span></span><br><span class="line"><span class="string"><span class="variable">$resourceGroupName</span> = <span class="variable">$snapshot</span>.ResourceGroupName</span></span><br><span class="line"><span class="string"><span class="variable">$sas</span>=<span class="variable">$</span>(az snapshot grant-access --resource-group <span class="variable">$resourceGroupName</span> --name <span class="variable">$snapshotName</span> --duration-in-seconds <span class="variable">$sasExpiryDuration</span> --query [accessSas] -o tsv)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">az storage blob copy start --destination-blob <span class="variable">$destinationVHDFileName</span> --destination-container <span class="variable">$storageContainerName</span> --account-name <span class="variable">$storageAccountName</span> --account-key <span class="variable">$storageAccountKey</span> --source-uri <span class="variable">$sas</span> </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>Then we check it’s working well in container.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/04.vhd_move_blob.png" class=""><h5 id="3-blob-to-blob-target-Subscription"><a href="#3-blob-to-blob-target-Subscription" class="headerlink" title="3. blob to blob(target Subscription)"></a>3. blob to blob(target Subscription)</h5><p>Need <code>two value</code> for this job.<br>One is <code>container path</code>, the other one is <code>SAS token</code>.<br>In the container List, click the right three dot. then click <code>container properties</code>.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/05.get_path.png" class=""><p>Then you check <code>URL</code>. memorize it for next CLI.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/05.get_path_url.png" class=""><p>Then in the left side bar in storage account, Click the ‘Shared Access Signature’.<br>Click the <code>container</code>, and the click <code>generate SAS ...</code> button.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/05.get_sas_01.png" class=""><p>then memorized <code>SAS token</code></p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/05.get_sas_token.png" class=""><p>And, you have target Subscription. create storage account and container.<br>I also create stoarge account named <code>yy1111targetmigrate</code><br>And container name is <code>vmdisktarget</code><br>And also get container path, SAS token.</p><h5 id="3-blob-to-blob-target-Subscription-1"><a href="#3-blob-to-blob-target-Subscription-1" class="headerlink" title="3. blob to blob(target Subscription)"></a>3. blob to blob(target Subscription)</h5><p>use following command.</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$srcPath</span> = <span class="string">&quot;https://yy1111migratestorage.blob.core.windows.net/vmdisk&quot;</span></span><br><span class="line"><span class="variable">$srcSAS</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="variable">$destPath</span> =<span class="string">&quot;https://yy1111targetmigrate.blob.core.windows.net/vmdisktarget&quot;</span></span><br><span class="line"><span class="variable">$destSAS</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">azcopy <span class="built_in">cp</span> <span class="variable">$srcPath</span><span class="variable">$srcSAS</span> <span class="variable">$destPath</span><span class="variable">$destSAS</span> -<span class="literal">-recursive</span></span><br></pre></td></tr></table></figure><p>It’s spend a few minutes. it depends on disk size.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/06.blob_to_blob_process.png" class=""><p>A few minutes later, process is done like under screen.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/07.return_blob_copy_done.png" class=""><p>And you check target container, vhd is visible.<br>you click refresh button if modified time is changed continuous.<br>then you wait more.</p><img src="/2020/12/14/20201214-az-vm-copy-other-sub/08.check_blob_copy_list.png" class=""><h5 id="4-make-disk-by-VHD-in-blob"><a href="#4-make-disk-by-VHD-in-blob" class="headerlink" title="4. make disk by VHD in blob"></a>4. make disk by VHD in blob</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$resourceGroupName</span> = <span class="string">&#x27;target-rg&#x27;</span></span><br><span class="line"><span class="variable">$resourceGroup</span> = <span class="built_in">Get-AzureRmResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$resourceGroupName</span></span><br><span class="line"><span class="variable">$location</span> = <span class="variable">$resourceGroup</span>.Location</span><br><span class="line"><span class="variable">$StorageAccountName</span> = <span class="string">&#x27;yy1111targetmigrate&#x27;</span></span><br><span class="line"><span class="variable">$containerName</span> = <span class="string">&#x27;vmdisktarget&#x27;</span></span><br><span class="line"><span class="variable">$storageAccount</span> = <span class="built_in">Get-AzStorageAccount</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Name</span> <span class="variable">$StorageAccountName</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$list</span> = az storage blob list <span class="literal">-c</span> <span class="variable">$containerName</span> -<span class="literal">-account</span><span class="literal">-name</span> <span class="variable">$StorageAccountName</span> | <span class="built_in">ConvertFrom-Json</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$sourceUri_prefix</span> = <span class="string">&#x27;https://&#x27;</span> + <span class="variable">$storageAccountName</span> + <span class="string">&#x27;.blob.core.windows.net/&#x27;</span> + <span class="variable">$containerName</span> + <span class="string">&#x27;/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Foreach</span>(<span class="variable">$list</span> <span class="keyword">in</span> <span class="variable">$List</span>) &#123; </span><br><span class="line"><span class="variable">$sourceUri</span> = <span class="variable">$sourceUri_prefix</span> + <span class="variable">$list</span>.name</span><br><span class="line"><span class="variable">$osDiskName</span> = <span class="variable">$list</span>.name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">write-host</span> <span class="variable">$sourceUri</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">New-AzDisk</span> <span class="literal">-DiskName</span> <span class="variable">$osDiskName</span> <span class="literal">-Disk</span> `</span><br><span class="line">(<span class="built_in">New-AzDiskConfig</span> <span class="literal">-AccountType</span> Premium_LRS <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-CreateOption</span> Import <span class="literal">-SourceUri</span> <span class="variable">$sourceUri</span> <span class="literal">-StorageAccountId</span> <span class="variable">$storageAccount</span>.Id) `</span><br><span class="line"><span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-AsJob</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Job</span> | <span class="built_in">Wait-Job</span></span><br><span class="line"><span class="string">&quot;All jobs completed&quot;</span></span><br><span class="line"><span class="built_in">get-AzDisk</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> | <span class="built_in">format-table</span> Name, ResourceGroupName</span><br></pre></td></tr></table></figure><p>And then check Disks in the portal.</p><h5 id="5-create-vm-using-disk"><a href="#5-create-vm-using-disk" class="headerlink" title="5. create vm using disk"></a>5. create vm using disk</h5><p>Execute following command. but, you should modify variable appropriately</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$List</span> = <span class="selector-tag">@</span>( </span><br><span class="line">  <span class="selector-tag">@</span>&#123; name=<span class="string">&#x27;target-vm&#x27;</span>; privateIpAddress=<span class="string">&#x27;10.0.0.4&#x27;</span>; vmSize=<span class="string">&#x27;Standard_D2s_v3&#x27;</span>; publicIpName=<span class="string">&#x27;&#x27;</span>;&#125;</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="variable">$resourceGroupName</span> = <span class="string">&#x27;target-rg&#x27;</span></span><br><span class="line"><span class="variable">$vnetName</span> = <span class="string">&quot;target-vnet&quot;</span> </span><br><span class="line"><span class="variable">$subnetName</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="variable">$nsgName</span> = <span class="string">&quot;prd-web-nsg&quot;</span></span><br><span class="line"><span class="variable">$storageType</span> = <span class="string">&#x27;Premium_LRS&#x27;</span></span><br><span class="line"><span class="variable">$dataDiskCaching</span>=<span class="string">&#x27;ReadOnly&#x27;</span></span><br><span class="line"><span class="variable">$resourceGroup</span> = <span class="built_in">Get-AzureRmResourceGroup</span> <span class="literal">-Name</span> <span class="variable">$resourceGroupName</span></span><br><span class="line"><span class="variable">$location</span> = <span class="variable">$resourceGroup</span>.Location</span><br><span class="line"><span class="variable">$storageAccountName</span> = <span class="string">&#x27;osstemprddiag&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Foreach</span>(<span class="variable">$list</span> <span class="keyword">in</span> <span class="variable">$List</span>) &#123; </span><br><span class="line"><span class="variable">$vmName</span> = <span class="variable">$list</span>.name</span><br><span class="line"><span class="variable">$privateIpAddress</span>= <span class="variable">$list</span>.privateIpAddress</span><br><span class="line"><span class="variable">$vmSize</span>= <span class="variable">$list</span>.vmSize</span><br><span class="line"><span class="variable">$publicIPName</span> = <span class="variable">$list</span>.publicIpName</span><br><span class="line"><span class="variable">$publicIp</span> = <span class="string">&#x27;&#x27;</span> </span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$publicIpName</span>) &#123; </span><br><span class="line"><span class="variable">$publicIp</span> = <span class="built_in">Get-AzureRmPublicIpAddress</span> <span class="literal">-Name</span> <span class="variable">$publicIpName</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$osDiskName</span> = <span class="variable">$vmName</span> + <span class="string">&#x27;_OsDisk_0&#x27;</span></span><br><span class="line"><span class="variable">$dataDiskName</span> = <span class="variable">$vmName</span> + <span class="string">&#x27;_DataDisk_0&#x27;</span></span><br><span class="line"><span class="variable">$nicName</span> = <span class="variable">$vmName</span> + <span class="string">&quot;-nic01&quot;</span></span><br><span class="line"><span class="variable">$Lun</span>=<span class="variable">$dataDiskName</span>.substring(<span class="variable">$dataDiskName</span>.length<span class="literal">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. get nic information </span></span><br><span class="line"><span class="variable">$vnet</span> = <span class="built_in">get-AzVirtualNetwork</span> <span class="literal">-Name</span> <span class="variable">$vnetName</span> </span><br><span class="line"><span class="variable">$nsg</span> = <span class="built_in">Get-AzureRmNetworkSecurityGroup</span> <span class="literal">-Name</span> <span class="variable">$nsgName</span></span><br><span class="line"><span class="variable">$subnet</span> = <span class="built_in">Get-AzureRmVirtualNetworkSubnetConfig</span> <span class="literal">-virtualNetwork</span> <span class="variable">$vnet</span> <span class="literal">-Name</span> <span class="variable">$subnetName</span></span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">Get-AzureRmNetworkInterface</span> <span class="literal">-Name</span> <span class="variable">$nicName</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$nic</span>) &#123; </span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$publicIpName</span>) &#123; </span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzNetworkInterface</span> <span class="literal">-Name</span> <span class="variable">$nicName</span> <span class="literal">-PrivateIpAddress</span> <span class="variable">$privateIpAddress</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-SubnetId</span>  <span class="variable">$subnet</span>.id <span class="literal">-NetworkSecurityGroupId</span> <span class="variable">$nsg</span>.Id <span class="literal">-PublicIpAddressId</span> <span class="variable">$publicIp</span>.id </span><br><span class="line"></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123; </span><br><span class="line"><span class="variable">$nic</span> = <span class="built_in">New-AzNetworkInterface</span> <span class="literal">-Name</span> <span class="variable">$nicName</span> <span class="literal">-PrivateIpAddress</span> <span class="variable">$privateIpAddress</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-SubnetId</span>  <span class="variable">$subnet</span>.id <span class="literal">-NetworkSecurityGroupId</span> <span class="variable">$nsg</span>.Id </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. get osDisk information   </span></span><br><span class="line"><span class="variable">$osDisk</span> = <span class="built_in">Get-AzureRmDisk</span> <span class="literal">-DiskName</span> <span class="variable">$osDiskName</span></span><br><span class="line"><span class="variable">$dataDisk</span> = <span class="built_in">Get-AzureRmDisk</span> <span class="literal">-DiskName</span> <span class="variable">$dataDiskName</span></span><br><span class="line"><span class="variable">$osDiskSizeGB</span>=<span class="variable">$osDisk</span>.DiskSizeGB</span><br><span class="line"><span class="variable">$dataDiskSizeGB</span>=<span class="variable">$dataDisk</span>.DiskSizeGB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. set vm configuration</span></span><br><span class="line"><span class="variable">$vmConfig</span> = <span class="built_in">New-AzVMConfig</span> <span class="literal">-VMName</span> <span class="variable">$vmName</span> <span class="literal">-VMSize</span> <span class="variable">$vmSize</span> </span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">Add-AzVMNetworkInterface</span> <span class="literal">-VM</span> <span class="variable">$vmConfig</span> <span class="literal">-Id</span> <span class="variable">$nic</span>.Id </span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">Set-AzVMOSDisk</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-ManagedDiskId</span> <span class="variable">$osDisk</span>.id <span class="literal">-StorageAccountType</span> <span class="variable">$storageType</span> <span class="literal">-DiskSizeInGB</span> <span class="variable">$osDiskSizeGB</span> <span class="literal">-CreateOption</span> Attach <span class="literal">-Windows</span></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">Add-AzVMDataDisk</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-Name</span> <span class="variable">$dataDiskName</span> <span class="literal">-DiskSizeInGB</span> <span class="variable">$dataDiskSizeGB</span> <span class="literal">-StorageAccountType</span> <span class="variable">$storageType</span> <span class="literal">-Caching</span> <span class="variable">$dataDiskCaching</span> <span class="literal">-Lun</span> <span class="variable">$Lun</span> <span class="literal">-CreateOption</span> Attach  <span class="literal">-ManagedDiskId</span> <span class="variable">$dataDisk</span>.id</span><br><span class="line"></span><br><span class="line"><span class="variable">$vm</span> = <span class="built_in">Set-AzVMBootDiagnostic</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-Enable</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-StorageAccountName</span> <span class="variable">$storageAccountName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. create vm </span></span><br><span class="line"><span class="built_in">New-AzVM</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$resourceGroupName</span> <span class="literal">-Location</span> <span class="variable">$location</span> <span class="literal">-VM</span> <span class="variable">$vm</span> <span class="literal">-LicenseType</span> <span class="string">&#x27;Windows_Server&#x27;</span> <span class="literal">-AsJob</span></span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#Get-Job | Wait-Job</span></span><br><span class="line"><span class="string">&quot;All jobs completed&quot;</span></span><br><span class="line"><span class="comment">#get-AzVM -ResourceGroupName $resourceGroupName | format-table Name, ResourceGroupName</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Thanks.</p><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/">VM</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Copy/">Copy</category>
      
      <category domain="https://yy1111yang.github.io/tags/Move/">Move</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/14/20201214-az-vm-copy-other-sub/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Search unused resource using resource-graph-explorer</title>
      <link>https://yy1111yang.github.io/2020/12/13/20201214-resource-graph/</link>
      <guid>https://yy1111yang.github.io/2020/12/13/20201214-resource-graph/</guid>
      <pubDate>Sun, 13 Dec 2020 18:23:14 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;Today, i post about search unused resource using resource-graph-explorer &amp;amp; dashboard&lt;/p&gt;
&lt;p&gt;You move to ‘Resource-Graph-Explorer’ in </description>
        
      
      
      
      <content:encoded><![CDATA[<p>Today, i post about search unused resource using resource-graph-explorer &amp; dashboard</p><p>You move to ‘Resource-Graph-Explorer’ in Azure Portal.<br>And then you can query anything.</p><p>First, you query this command. it’s same query under the picture.</p><img src="/2020/12/13/20201214-resource-graph/01.query_sample.png" class=""><p><strong>disabled nic Accelerate</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| <span class="built_in">where</span> <span class="built_in">type</span> == <span class="string">&quot;microsoft.network/networkinterfaces&quot;</span> and properties [<span class="string">&quot;enableAcceleratedNetworking&quot;</span>] == <span class="string">&quot;false&quot;</span></span><br><span class="line">| project resourceGroup, name</span><br></pre></td></tr></table></figure><p><strong>note: i capture without</strong> <code>|project resourceGroup, name</code></p><p>And you can save query. Click <code>save as</code> button.<br>Type the name appropriate about query function.<br>You can choice type <code>private</code>, <code>public</code>. this time, i saved <code>private</code></p><img src="/2020/12/13/20201214-resource-graph/02.save_query.png" class=""><p>Then, you find query name changed.<br>And we pin to dashboard this query. Click the button <code>pin to dashboard</code></p><img src="/2020/12/13/20201214-resource-graph/03.query_name_change.png" class=""><p>Create new dashboard with private. then Click <code>create</code> button</p><img src="/2020/12/13/20201214-resource-graph/04.pin_dashboard.png" class=""><p>It’s working good. then i added additional query in dashboard.</p><img src="/2020/12/13/20201214-resource-graph/05.view_dashboard.png" class=""><p>*<em>no associated Nic</em></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| <span class="built_in">where</span> <span class="built_in">type</span> == <span class="string">&quot;microsoft.network/networkinterfaces&quot;</span> and isnull(properties.virtualMachine)</span><br><span class="line">| project resourceGroup, name</span><br></pre></td></tr></table></figure><p><strong>no custom dns settings</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| <span class="built_in">where</span> <span class="built_in">type</span> == <span class="string">&quot;microsoft.network/networkinterfaces&quot;</span> and array_length(properties.dnsSettings.appliedDnsServers) == <span class="number">0</span></span><br><span class="line">| project resourceGroup, name</span><br></pre></td></tr></table></figure><p><strong>no attached managed disks</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| <span class="built_in">where</span> <span class="built_in">type</span> == <span class="string">&quot;microsoft.compute/disks&quot;</span> and isempty(managedBy)</span><br><span class="line">| project resourceGroup, name</span><br></pre></td></tr></table></figure><p><strong>no assocated nsg</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| <span class="built_in">where</span> <span class="built_in">type</span> == <span class="string">&quot;microsoft.network/networksecuritygroups&quot;</span> and isnull(properties.networkInterfaces)</span><br><span class="line">and isnull(properties.subnets)</span><br><span class="line">| project resourceGroup, name</span><br></pre></td></tr></table></figure><p><strong>no associated pip</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Resources</span><br><span class="line">| <span class="built_in">where</span> <span class="built_in">type</span> == <span class="string">&quot;microsoft.network/publicipaddresses&quot;</span></span><br><span class="line">| <span class="built_in">where</span> isnull(properties.ipConfiguration) or isempty(properties.ipConfiguration)</span><br><span class="line">| project resourceGroup, name</span><br></pre></td></tr></table></figure><p>Then, i added all query to dashboard.<br>It’s good job!</p><img src="/2020/12/13/20201214-resource-graph/06.finish_dashboard.png" class=""><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/">VM</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Resource/">Resource</category>
      
      <category domain="https://yy1111yang.github.io/tags/Graph/">Graph</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/13/20201214-resource-graph/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Internet connection not working in VM after connection LB.</title>
      <link>https://yy1111yang.github.io/2020/12/12/20201213-azure-lb-nat-problem/</link>
      <guid>https://yy1111yang.github.io/2020/12/12/20201213-azure-lb-nat-problem/</guid>
      <pubDate>Sat, 12 Dec 2020 23:03:17 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;Azure vm can connection internet outbound without public ip.&lt;br&gt;But Somtimes internet connection &lt;strong&gt;not working&lt;/strong&gt; after conne</description>
        
      
      
      
      <content:encoded><![CDATA[<p>Azure vm can connection internet outbound without public ip.<br>But Somtimes internet connection <strong>not working</strong> after connection LB.</p><p>Exactly, Occurs when the following conditions are combined.<br><strong>First, using Standard Load balancer.</strong><br><strong>Second, config Az set.</strong></p><p>Currently, some region include south korea not support zone. so use only az set.</p><p>There is <code>Four solution</code> solving this problem.<br><strong>1, change the sku ‘basic’ in Load balancer.</strong><br><strong>2, assoicated public ip in VM.</strong><br><strong>3, using public Load balancer NAT outbound.</strong><br><strong>4, using Nat Gateway.</strong></p><p>then, i show demo about solutions about NAT.<br>Create vm wwith Az Set.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/01.create_vm_01.png" class=""><p>Deploy is done. then <code>access</code> vm.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/02.vm_show_01.png" class=""><p>I check internet connection is <code>enabled</code>.<br>it’s good well.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/03.internet_test_01.png" class=""><p>Then, create Standard Load balancer. select <code>type</code> <code>sku</code> below picture.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/04.create_lb_01.png" class=""><p>it’s deployed LB. then add Backend pool.<br>skip the add <code>probe</code>,<code>rule</code>.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/05.lb_show_01.png" class=""><p>and, we access vm again. then check innternet connection.<br><strong>it’s not working..</strong></p><img src="/2020/12/12/20201213-azure-lb-nat-problem/06.internet_test_02.png" class=""><p>so, we create Nat LB to solve this problem.<br><strong>Create Public LB like under picture.</strong></p><img src="/2020/12/12/20201213-azure-lb-nat-problem/07.create_plb_01.png" class=""><p>And add Backend pool like screen.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/08.setting_plb_01.png" class=""><p>add <code>outbound rule</code></p><img src="/2020/12/12/20201213-azure-lb-nat-problem/08.setting_plb_02.png" class=""><p>Select <code>FrontendIp</code>, <code>backend pool</code><br>then others set to default.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/08.setting_plb_03.png" class=""><p>After complete setting, again check internet connection in VM.<br>This time, To check <code>NAT IP</code>, connect <code>whatismyip</code> web page.<br>We check return frontendIP in Public LoadBalcer.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/09.internet_test_01.png" class=""><p>And we <strong>delete public LB for test NAT gateway</strong></p><img src="/2020/12/12/20201213-azure-lb-nat-problem/10.delete_plb.png" class=""><p>Again check internet connection. <code>again not working.</code></p><img src="/2020/12/12/20201213-azure-lb-nat-problem/11.internet_test_01.png" class=""><p>Then create <code>NAT gateway</code> like under the picture.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/12.create_natgateway_01.png" class=""><p>Add setting abbout Outbound IP.<br>Create one Public Ip, a public Ip prefix. we only create 2 range.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/12.create_natgateway_02.png" class=""><p>Set the subnet associated gateway.</p><img src="/2020/12/12/20201213-azure-lb-nat-problem/12.create_natgateway_03.png" class=""><p>After set the settings, go to the vm.<br>Again check status. it’s working well.<br>And <strong>we know this ip is one of public ip prefix range.</strong></p><img src="/2020/12/12/20201213-azure-lb-nat-problem/14.internet_test_01.png" class=""><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/">VM</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/VM/">VM</category>
      
      <category domain="https://yy1111yang.github.io/tags/LB/">LB</category>
      
      <category domain="https://yy1111yang.github.io/tags/NAT/">NAT</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/12/20201213-azure-lb-nat-problem/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure VM Copy using Snapshot</title>
      <link>https://yy1111yang.github.io/2020/12/11/20201212-az-vm-copy-01/</link>
      <guid>https://yy1111yang.github.io/2020/12/11/20201212-az-vm-copy-01/</guid>
      <pubDate>Fri, 11 Dec 2020 16:14:00 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;This post about Azure VM Copy using snapshot.&lt;/p&gt;
&lt;h3 id=&quot;The-total-process-is-as-follow&quot;&gt;&lt;a href=&quot;#The-total-process-is-as-follow&quot; class</description>
        
      
      
      
      <content:encoded><![CDATA[<p>This post about Azure VM Copy using snapshot.</p><h3 id="The-total-process-is-as-follow"><a href="#The-total-process-is-as-follow" class="headerlink" title="The total process is as follow."></a>The total process is as follow.</h3><ol><li>OsDisk, Datadisk =&gt; snapshot</li><li>snapshot =&gt; OsDisk_copy, Datadisk_copy</li><li>OsDisk_copy, Datadisk_copy =&gt; VM_copy  </li></ol><p><strong>1. Create Snapshot.</strong><br>Go to the panel in OsDisk. Click <code>+Create Snapshot</code></p><img src="/2020/12/11/20201212-az-vm-copy-01/disk_show_01.png" class=""><p>Move screen for create snapshot.<br>Type the name, select Storage type.<br>We can changed storage type after create disk in disk screen. </p><img src="/2020/12/11/20201212-az-vm-copy-01/snapshot_create_01.png" class=""><p><strong>2. Create Disk_Copy.</strong><br>Snapshot also create to managed disk directly.<br>Click button <code>+Create Disk</code> in upper.</p><img src="/2020/12/11/20201212-az-vm-copy-01/snapshot_show_01.png" class=""><p>Go to the screen for create VM.<br>Type the name and select the sku.</p><img src="/2020/12/11/20201212-az-vm-copy-01/disk_create_01.png" class=""><p><strong>3. Create VM</strong><br>About 30 sec later, created Disk.<br>And suppport create VM Directly using managed disk in Auzre Portal.<br>It’s very useful i think.<br>Click the button <code>+Create VM</code> and skip the creating VM. </p><img src="/2020/12/11/20201212-az-vm-copy-01/create_vm_01.png" class=""><p>Finally deploy VM is done. we memorized public IP for connection RDP.</p><img src="/2020/12/11/20201212-az-vm-copy-01/vm_show_01.png" class=""><p>We find the certification name below. it’s VM name copied VM before.<br>So, we know vm copy is successful.</p><img src="/2020/12/11/20201212-az-vm-copy-01/rdp_show_01.png" class=""><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/VM/">VM</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/VM/">VM</category>
      
      <category domain="https://yy1111yang.github.io/tags/Snapshot/">Snapshot</category>
      
      <category domain="https://yy1111yang.github.io/tags/Copy/">Copy</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/11/20201212-az-vm-copy-01/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>How can we check network connection between Azure VM</title>
      <link>https://yy1111yang.github.io/2020/12/10/20201211-az-vm-network-connect/</link>
      <guid>https://yy1111yang.github.io/2020/12/10/20201211-az-vm-network-connect/</guid>
      <pubDate>Thu, 10 Dec 2020 23:09:26 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;How can we check network connection between VM?&lt;/p&gt;
&lt;p&gt;First, i &lt;code&gt;deploy two Azure VM in same vnet.&lt;/code&gt;&lt;/p&gt;
&lt;img src=&quot;/2020/12/10/</description>
        
      
      
      
      <content:encoded><![CDATA[<p>How can we check network connection between VM?</p><p>First, i <code>deploy two Azure VM in same vnet.</code></p><img src="/2020/12/10/20201211-az-vm-network-connect/vm_list_01.png" class=""><p>I will check network connection <code>10.0.0.4 =&gt; 10.0.0.5:8080</code><br>Already i install IIS in 10.0.0.5 and change listen port 80 to 8080.<br>Usually we can telnet or ping.<br>But i use powershell command as following. </p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Test-NetConnection</span> [<span class="type">IP</span> <span class="type">Address</span> <span class="type">or</span> <span class="type">ComputerName</span>] <span class="literal">-port</span> [<span class="type">Port</span> <span class="type">Number</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Exmaple</span></span><br><span class="line"><span class="built_in">Test-NetConnection</span> <span class="number">10.0</span>.<span class="number">0.5</span> <span class="literal">-port</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>Oops… I return TcpTestSucceded:<code>False</code>.</p><img src="/2020/12/10/20201211-az-vm-network-connect/test_netconnection_01.png" class=""><h5 id="1-Check-Windows-firewall"><a href="#1-Check-Windows-firewall" class="headerlink" title="1. Check Windows firewall."></a>1. Check Windows firewall.</h5><p>First, We open <code>Window Firewall with Advanced Security</code> in Windows.</p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_01.png" class=""><p>Right Click on <code>InboundRule</code> in left sidebar, and add a rule.<br>Click <code>Port</code> then <code>next</code> like under the picture.</p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_02.png" class=""><p>Select <code>Protocol(TCP)</code> then type port for open. we should type 8080 in case.</p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_03.png" class=""><p>And then we select Allow, Block about rule.<br>We have to Allow connection, so we select <code>Allow the connection</code></p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_04.png" class=""><p>Select Default value.</p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_05.png" class=""><p>And type rule name and description you want.</p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_06.png" class=""><p>We checked rule added. left green light means rule enabled.</p><img src="/2020/12/10/20201211-az-vm-network-connect/window_firewall_07.png" class=""><p>Ok. we check network connection again.<br>But.. we can’t reach destination…</p><img src="/2020/12/10/20201211-az-vm-network-connect/test_netconnection_02.png" class=""><h5 id="2-Using-azure-trouble-shoot"><a href="#2-Using-azure-trouble-shoot" class="headerlink" title="2. Using azure trouble shoot"></a>2. Using azure trouble shoot</h5><p>Maybe i think it block in NSG.<br>If we have under 10 rule in NSG, we find the block rule easily.<br>But over 10 rule, it’s too hard find it.<br>Then we use Azure Troble Shoot.</p><p>In VM panel, in <strong>Azure Portal. &gt; Connection troubleshoot &gt; Use Network Watcher for detailed connectio tracing</strong></p><img src="/2020/12/10/20201211-az-vm-network-connect/troubleshoot_01.png" class=""><p>Select <code>Specify manually</code>, then type Target IP(10.0.0.5).<br>Type port 8080 below input box.<br>Then Click <code>Check</code></p><img src="/2020/12/10/20201211-az-vm-network-connect/troubleshoot_02.png" class=""><p>We return result. if you check first time, it’s longer then you think.<br>Because install network watcher.<br>Then the status is Unreachable.<br>We find the problem about status of 10.0.0.4.<br>Then Click the row about 10.0.0.4.<br><strong>It blocked rule named 8080-outbound-allow.</strong></p><img src="/2020/12/10/20201211-az-vm-network-connect/troubleshoot_03.png" class=""><h5 id="3-check-azure-nsg"><a href="#3-check-azure-nsg" class="headerlink" title="3. check azure nsg"></a>3. check azure nsg</h5><p>We go to NSG cause block problem.<br>Oops, i added Deny Rule. not Allow. i changed action to Allow </p><img src="/2020/12/10/20201211-az-vm-network-connect/troubleshoot_04.png" class=""><p>And then i check status, we finally connection <code>succecssful</code></p><img src="/2020/12/10/20201211-az-vm-network-connect/test_netconnection_03.png" class=""><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Windows/">Windows</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Windows/">Windows</category>
      
      <category domain="https://yy1111yang.github.io/tags/Network/">Network</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/10/20201211-az-vm-network-connect/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Useful CLI about Azure NSG</title>
      <link>https://yy1111yang.github.io/2020/12/10/20201211-az-nsg-cli/</link>
      <guid>https://yy1111yang.github.io/2020/12/10/20201211-az-nsg-cli/</guid>
      <pubDate>Thu, 10 Dec 2020 20:29:24 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Search-Rule-include-‘Any-Port’&quot;&gt;&lt;a href=&quot;#Search-Rule-include-‘Any-Port’&quot; class=&quot;headerlink&quot; title=&quot;Search Rule include ‘Any Port’&quot;&gt;</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Search-Rule-include-‘Any-Port’"><a href="#Search-Rule-include-‘Any-Port’" class="headerlink" title="Search Rule include ‘Any Port’"></a>Search Rule include ‘Any Port’</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$inbound</span> = <span class="selector-tag">@</span>();</span><br><span class="line"><span class="variable">$outbound</span> = <span class="selector-tag">@</span>();</span><br><span class="line"><span class="variable">$nsgList</span> = az network nsg list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$nsg</span> <span class="keyword">in</span> <span class="variable">$nsgList</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$rule</span> <span class="keyword">in</span> <span class="variable">$nsg</span>.securityRules) &#123;</span><br><span class="line">                <span class="keyword">if</span>( <span class="variable">$rule</span>.destinationPortRange <span class="operator">-eq</span> <span class="string">&#x27;*&#x27;</span> ) &#123;</span><br><span class="line">                        <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                        nsgName=<span class="variable">$nsg</span>.name</span><br><span class="line">                                        direction=<span class="variable">$rule</span>.direction</span><br><span class="line">                                        priority=<span class="variable">$rule</span>.priority</span><br><span class="line">                                        ruleName=<span class="variable">$rule</span>.name</span><br><span class="line">                                        source=<span class="string">&#x27;&#x27;</span></span><br><span class="line">                                        dest=<span class="string">&#x27;&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$rule</span>.direction <span class="operator">-eq</span> <span class="string">&#x27;Inbound&#x27;</span>) &#123;</span><br><span class="line">                                <span class="variable">$inbound</span> += <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="variable">$outbound</span> += <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$inbound</span> | <span class="built_in">select-object</span> nsgName, direction, ruleName, priority, source, dest | <span class="built_in">sort-object</span> <span class="literal">-property</span> nsgName, priority | <span class="built_in">format-table</span></span><br><span class="line"><span class="variable">$outbound</span> | <span class="built_in">select-object</span> nsgName, direction, ruleName, priority, source, dest | <span class="built_in">sort-Object</span> <span class="literal">-property</span> nsgName, priority | <span class="built_in">format-table</span></span><br></pre></td></tr></table></figure><h2 id="Search-NSG-Rule-include-‘Any-Source-Any-Destination’"><a href="#Search-NSG-Rule-include-‘Any-Source-Any-Destination’" class="headerlink" title="Search NSG Rule include ‘Any Source, Any Destination’"></a>Search NSG Rule include ‘Any Source, Any Destination’</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$inbound</span> = <span class="selector-tag">@</span>();</span><br><span class="line"><span class="variable">$outbound</span> = <span class="selector-tag">@</span>();</span><br><span class="line"><span class="variable">$nsgList</span> = az network nsg list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$nsg</span> <span class="keyword">in</span> <span class="variable">$nsgList</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$rule</span> <span class="keyword">in</span> <span class="variable">$nsg</span>.securityRules) &#123;</span><br><span class="line">                <span class="keyword">if</span>( <span class="variable">$rule</span>.sourceAddressPrefix <span class="operator">-eq</span> <span class="string">&#x27;*&#x27;</span> <span class="operator">-OR</span> <span class="variable">$rule</span>.destinationAddressPrefix <span class="operator">-eq</span> <span class="string">&#x27;*&#x27;</span> ) &#123;</span><br><span class="line">                        <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                        nsgName=<span class="variable">$nsg</span>.name</span><br><span class="line">                                        direction=<span class="variable">$rule</span>.direction</span><br><span class="line">                                        priority=<span class="variable">$rule</span>.priority</span><br><span class="line">                                        ruleName=<span class="variable">$rule</span>.name</span><br><span class="line">                                        source=<span class="string">&#x27;&#x27;</span></span><br><span class="line">                                        dest=<span class="string">&#x27;&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$rule</span>.direction <span class="operator">-eq</span> <span class="string">&#x27;Inbound&#x27;</span>) &#123;</span><br><span class="line">                                <span class="variable">$inbound</span> += <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="variable">$outbound</span> += <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$inbound</span> | <span class="built_in">select-object</span> nsgName, direction, ruleName, priority, source, dest | <span class="built_in">sort-object</span> <span class="literal">-property</span> nsgName, priority | <span class="built_in">format-table</span></span><br><span class="line"><span class="variable">$outbound</span> | <span class="built_in">select-object</span> nsgName, direction, ruleName, priority, source, dest | <span class="built_in">sort-Object</span> <span class="literal">-property</span> nsgName, priority | <span class="built_in">format-table</span></span><br></pre></td></tr></table></figure><h2 id="Export-NSG-to-CSV-by-resourceGroup"><a href="#Export-NSG-to-CSV-by-resourceGroup" class="headerlink" title="Export NSG to CSV by resourceGroup"></a>Export NSG to CSV by resourceGroup</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">param</span>(<span class="variable">$rgName</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rgName</span> <span class="operator">-eq</span> <span class="variable">$null</span>) &#123;</span><br><span class="line">  <span class="variable">$rgName</span> = <span class="built_in">read-host</span> <span class="literal">-Prompt</span> <span class="string">&quot;please enter a rgName&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$nsgs</span> = <span class="built_in">Get-AzureRmNetworkSecurityGroup</span> <span class="literal">-ResourceGroupName</span> <span class="variable">$rgName</span></span><br><span class="line"><span class="variable">$exportPath</span> = <span class="string">&#x27;.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#backup nsgs to csv</span></span><br><span class="line"><span class="keyword">Foreach</span> (<span class="variable">$nsg</span> <span class="keyword">in</span> <span class="variable">$nsgs</span>) &#123;</span><br><span class="line">    <span class="built_in">New-Item</span> <span class="literal">-ItemType</span> file <span class="literal">-Path</span> <span class="string">&quot;<span class="variable">$exportPath</span>\<span class="variable">$</span>(<span class="variable">$nsg</span>.Name).csv&quot;</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$nsgRules</span> = <span class="variable">$nsg</span>.SecurityRules | <span class="built_in">Sort-Object</span> <span class="selector-tag">@</span>&#123; e = <span class="string">&#x27;Direction&#x27;</span>; a = <span class="variable">$true</span> &#125;, <span class="selector-tag">@</span>&#123; e = <span class="string">&#x27;Priority&#x27;</span>; a = <span class="variable">$true</span> &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$nsgRule</span> <span class="keyword">in</span> <span class="variable">$nsgRules</span>) &#123;</span><br><span class="line">        <span class="variable">$nsgRule</span> | <span class="built_in">Select-Object</span> Name,Direction,Access,Priority,Protocol,<span class="selector-tag">@</span>&#123;Name=’SourceAddressPrefix’;Expression=&#123;[<span class="built_in">string</span>]::join(“ ”, (<span class="variable">$_</span>.SourceAddressPrefix))&#125;&#125;,<span class="selector-tag">@</span>&#123;Name=’SourcePortRange’;Expression=&#123;[<span class="built_in">string</span>]::join(“ ”, (<span class="variable">$_</span>.SourcePortRange))&#125;&#125;,<span class="selector-tag">@</span>&#123;Name=’DestinationAddressPrefix’;Expression=&#123;[<span class="built_in">string</span>]::join(“ ”, (<span class="variable">$_</span>.DestinationAddressPrefix))&#125;&#125;,<span class="selector-tag">@</span>&#123;Name=’DestinationPortRange’;Expression=&#123;[<span class="built_in">string</span>]::join(“ ”, (<span class="variable">$_</span>.DestinationPortRange))&#125;&#125;,Description `</span><br><span class="line">        | <span class="built_in">Export-Csv</span> <span class="string">&quot;<span class="variable">$exportPath</span>\<span class="variable">$</span>(<span class="variable">$nsg</span>.Name).csv&quot;</span> <span class="literal">-NoTypeInformation</span> <span class="literal">-Encoding</span> UTF<span class="literal">-8</span> <span class="literal">-Append</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Get-Nsg-rule-include-specific-IP"><a href="#Get-Nsg-rule-include-specific-IP" class="headerlink" title="Get Nsg rule include specific IP"></a>Get Nsg rule include specific IP</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">param</span>(<span class="variable">$checkIp</span>, <span class="variable">$rgName</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$checkIp</span> <span class="operator">-eq</span> <span class="variable">$null</span>) &#123;</span><br><span class="line">  <span class="variable">$checkIp</span> = <span class="built_in">read-host</span> <span class="literal">-Prompt</span> <span class="string">&quot;please enter a checkIp&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rgName</span> <span class="operator">-eq</span> <span class="variable">$null</span>) &#123;</span><br><span class="line">  <span class="variable">$rgName</span> = <span class="built_in">read-host</span> <span class="literal">-Prompt</span> <span class="string">&quot;please enter a rgName&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$inbound</span> = <span class="selector-tag">@</span>();</span><br><span class="line"><span class="variable">$outbound</span> = <span class="selector-tag">@</span>();</span><br><span class="line"><span class="variable">$nsgList</span> = az network nsg list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$nsg</span> <span class="keyword">in</span> <span class="variable">$nsgList</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$rule</span> <span class="keyword">in</span> <span class="variable">$nsg</span>.securityRules) &#123;</span><br><span class="line">                <span class="keyword">if</span>( <span class="variable">$rule</span>.sourceAddressPrefix <span class="operator">-eq</span> <span class="variable">$checkIp</span> <span class="operator">-or</span> <span class="variable">$rule</span>.destinationAddressPrefix <span class="operator">-eq</span> <span class="variable">$checkIp</span> `</span><br><span class="line">                        <span class="operator">-or</span> <span class="variable">$rule</span>.sourceAddressPrefixes <span class="operator">-contains</span> <span class="variable">$checkIp</span> <span class="operator">-or</span> <span class="variable">$rule</span>.destinationAddressPrefixes <span class="operator">-contains</span> <span class="variable">$checkIp</span>) &#123;</span><br><span class="line">                        <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                        nsgName=<span class="variable">$nsg</span>.name</span><br><span class="line">                                        direction=<span class="variable">$rule</span>.direction</span><br><span class="line">                                        priority=<span class="variable">$rule</span>.priority</span><br><span class="line">                                        ruleName=<span class="variable">$rule</span>.name</span><br><span class="line">                                        source=<span class="string">&#x27;&#x27;</span></span><br><span class="line">                                        dest=<span class="string">&#x27;&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$sourceAddressPrefix</span> <span class="operator">-eq</span> <span class="variable">$checkIp</span> <span class="operator">-or</span> <span class="variable">$rule</span>.sourceAddressPrefixes <span class="operator">-contains</span> <span class="variable">$checkIp</span> ) &#123;</span><br><span class="line">                                <span class="variable">$details</span>.source = <span class="string">&#x27;true&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$rule</span>.destinationAddressPrefix <span class="operator">-eq</span> <span class="variable">$checkIp</span> <span class="operator">-or</span> <span class="variable">$rule</span>.destinationAddressPrefixes <span class="operator">-contains</span> <span class="variable">$checkIp</span>) &#123;</span><br><span class="line">                                <span class="variable">$details</span>.dest = <span class="string">&#x27;true&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$rule</span>.direction <span class="operator">-eq</span> <span class="string">&#x27;Inbound&#x27;</span>) &#123;</span><br><span class="line">                                <span class="variable">$inbound</span> += <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="variable">$outbound</span> += <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$inbound</span> | <span class="built_in">select-object</span> nsgName, direction, ruleName, priority, source, dest | <span class="built_in">sort-object</span> <span class="literal">-property</span> nsgName, priority | <span class="built_in">format-table</span></span><br><span class="line"><span class="variable">$outbound</span> | <span class="built_in">select-object</span> nsgName, direction, ruleName, priority, source, dest | <span class="built_in">sort-Object</span> <span class="literal">-property</span> nsgName, priority | <span class="built_in">format-table</span></span><br></pre></td></tr></table></figure><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Powershell/">Powershell</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Powershell/">Powershell</category>
      
      <category domain="https://yy1111yang.github.io/tags/NSG/">NSG</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/10/20201211-az-nsg-cli/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Search Unused Resource in Azure using CLI</title>
      <link>https://yy1111yang.github.io/2020/12/10/20201211-az-no-associated-resource-cli/</link>
      <guid>https://yy1111yang.github.io/2020/12/10/20201211-az-no-associated-resource-cli/</guid>
      <pubDate>Thu, 10 Dec 2020 19:56:02 GMT</pubDate>
      
        
        
      <description>&lt;p&gt;Hi. sometimes, we forgot delete unused resource.&lt;br&gt;It cause only delete Azure VM not include attached resource such as disk, nic, nsg, p</description>
        
      
      
      
      <content:encoded><![CDATA[<p>Hi. sometimes, we forgot delete unused resource.<br>It cause only delete Azure VM not include attached resource such as disk, nic, nsg, public Ip.<br>Especially, you have over 100 resource in subscription… it’s hard to check it.<br>But, if you use CLI in this post, you can easy find it.</p><h2 id="Search-unattached-managed-disk"><a href="#Search-unattached-managed-disk" class="headerlink" title="Search unattached managed disk"></a>Search unattached managed disk</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write-host</span> <span class="string">&#x27;no associated disk searching...&#x27;</span></span><br><span class="line"><span class="variable">$results</span> = <span class="selector-tag">@</span>()</span><br><span class="line"><span class="variable">$diskList</span> = az disk list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="variable">$results</span> += <span class="variable">$diskList</span> | <span class="built_in">foreach-object</span> <span class="literal">-parallel</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$_</span>.managedBy) &#123;</span><br><span class="line">                <span class="variable">$noDisk</span> = <span class="variable">$_</span>.id <span class="operator">-split</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                rgName=<span class="variable">$noDisk</span>[<span class="number">4</span>]</span><br><span class="line">                                noAttachedDisk=<span class="variable">$noDisk</span>[<span class="number">8</span>]</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">write-host</span> (<span class="variable">$results</span> | <span class="built_in">select-object</span> rgName, noAttachedDisk | <span class="built_in">Sort-Object</span> &#123; <span class="variable">$_</span>.rgName&#125; | <span class="built_in">format-table</span> | <span class="built_in">Out-String</span>) <span class="literal">-ForegroundColor</span> Red</span><br></pre></td></tr></table></figure><h2 id="No-Associated-Public-IP"><a href="#No-Associated-Public-IP" class="headerlink" title="No Associated Public IP"></a>No Associated Public IP</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write-host</span> <span class="string">&#x27;no associated ip searching...&#x27;</span></span><br><span class="line"><span class="variable">$results</span> = <span class="selector-tag">@</span>()</span><br><span class="line"><span class="variable">$ipList</span> = az network public<span class="literal">-ip</span> list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="variable">$results</span> += <span class="variable">$ipList</span> | <span class="built_in">foreach-object</span> <span class="literal">-parallel</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="variable">$_</span>.ipConfiguration) &#123;</span><br><span class="line">                                <span class="variable">$noIp</span> = <span class="variable">$_</span>.id <span class="operator">-split</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                                <span class="comment">#write-host $noIp[4] : $noIp[8] -ForegroundColor Red</span></span><br><span class="line">                                <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                                rgName=<span class="variable">$noIp</span>[<span class="number">4</span>]</span><br><span class="line">                                                noAssocatedIP=<span class="variable">$noIp</span>[<span class="number">8</span>]</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">return</span> <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">write-host</span> ( <span class="variable">$results</span> | <span class="built_in">select-object</span> rgName, noAssocatedIp | <span class="built_in">Sort-Object</span> &#123; <span class="variable">$_</span>.rgName&#125; | <span class="built_in">format-table</span> | <span class="built_in">out-string</span> ) <span class="literal">-ForegroundColor</span> Red</span><br></pre></td></tr></table></figure><h2 id="No-Associated-NiC-to-VM"><a href="#No-Associated-NiC-to-VM" class="headerlink" title="No Associated NiC to VM"></a>No Associated NiC to VM</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write-host</span> <span class="string">&#x27;no associated nic searching...&#x27;</span></span><br><span class="line"><span class="variable">$results</span>= <span class="selector-tag">@</span>()</span><br><span class="line"><span class="variable">$nicList</span> = az network nic list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="variable">$results</span> += <span class="variable">$nicList</span> | <span class="built_in">foreach-object</span> <span class="literal">-parallel</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="variable">$_</span>.virtualMachine) &#123;</span><br><span class="line">                                <span class="variable">$noNic</span> = <span class="variable">$_</span>.id <span class="operator">-split</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                                <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                                rgName=<span class="variable">$noNic</span>[<span class="number">4</span>]</span><br><span class="line">                                                noAttachedNic=<span class="variable">$noNic</span>[<span class="number">8</span>]</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">return</span> <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">write-host</span> ( <span class="variable">$results</span> | <span class="built_in">select-object</span> rgName, noAttachedNic | <span class="built_in">Sort-Object</span> &#123; <span class="variable">$_</span>.rgName&#125; | <span class="built_in">format-table</span> | <span class="built_in">out-string</span> ) <span class="literal">-ForegroundColor</span> Red</span><br></pre></td></tr></table></figure><h2 id="No-Associated-NSG"><a href="#No-Associated-NSG" class="headerlink" title="No Associated NSG"></a>No Associated NSG</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">write-host</span> <span class="string">&#x27;no assocated nsg searching...&#x27;</span></span><br><span class="line"><span class="variable">$results</span> = <span class="selector-tag">@</span>()</span><br><span class="line"><span class="variable">$nsgList</span> = az network nsg list | <span class="built_in">convertFrom-Json</span></span><br><span class="line"><span class="variable">$results</span> += <span class="variable">$nsgList</span> | <span class="built_in">foreach-object</span> <span class="literal">-Parallel</span> &#123;</span><br><span class="line">                <span class="variable">$rtnNsg</span> = <span class="built_in">Get-AzNetworkSecurityGroup</span> <span class="literal">-name</span> <span class="variable">$_</span>.name</span><br><span class="line">                <span class="keyword">if</span>(!<span class="variable">$rtnNsg</span>.NetworkInterfaces <span class="operator">-and</span> !<span class="variable">$rtnNsg</span>.Subnets) &#123;</span><br><span class="line">                                <span class="variable">$noNsg</span> = <span class="variable">$_</span>.id <span class="operator">-split</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">                                <span class="variable">$details</span> = <span class="selector-tag">@</span>&#123;</span><br><span class="line">                                                rgName=<span class="variable">$noNsg</span>[<span class="number">4</span>]</span><br><span class="line">                                                noAssocatedNsg=<span class="variable">$noNsg</span>[<span class="number">8</span>]</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">return</span> <span class="built_in">New-Object</span> PSObject <span class="literal">-Property</span> <span class="variable">$details</span></span><br><span class="line">                &#125;</span><br><span class="line">&#125; <span class="literal">-ThrottleLimit</span> <span class="number">20</span></span><br><span class="line"><span class="built_in">write-host</span> ( <span class="variable">$results</span> | <span class="built_in">select-object</span> rgName, noAssocatedNsg | <span class="built_in">Sort-Object</span> &#123; <span class="variable">$_</span>.rgName&#125; | <span class="built_in">format-table</span> | <span class="built_in">out-string</span> ) <span class="literal">-ForegroundColor</span> Red</span><br></pre></td></tr></table></figure><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Powershell/">Powershell</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Powershell/">Powershell</category>
      
      <category domain="https://yy1111yang.github.io/tags/Unused-Resource/">Unused Resource</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/10/20201211-az-no-associated-resource-cli/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Azure Subscription change, check in CLI and powershell</title>
      <link>https://yy1111yang.github.io/2020/12/10/20201210-az-account-cli/</link>
      <guid>https://yy1111yang.github.io/2020/12/10/20201210-az-account-cli/</guid>
      <pubDate>Thu, 10 Dec 2020 02:37:02 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;Change-Current-Subscription&quot;&gt;&lt;a href=&quot;#Change-Current-Subscription&quot; class=&quot;headerlink&quot; title=&quot;Change Current Subscription.&quot;&gt;&lt;/a&gt;Chan</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="Change-Current-Subscription"><a href="#Change-Current-Subscription" class="headerlink" title="Change Current Subscription."></a>Change Current Subscription.</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$subName</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># powershell </span></span><br><span class="line"><span class="built_in">Set-AzureRmContext</span> <span class="literal">-Subscription</span> <span class="variable">$subName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># azure CLI</span></span><br><span class="line">az account <span class="built_in">set</span> <span class="literal">-s</span> <span class="variable">$subName</span></span><br></pre></td></tr></table></figure><h2 id="Show-Current-Subscription"><a href="#Show-Current-Subscription" class="headerlink" title="Show Current Subscription."></a>Show Current Subscription.</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># azure CLI</span></span><br><span class="line">az account show</span><br><span class="line"></span><br><span class="line"><span class="comment"># powershell</span></span><br><span class="line"><span class="built_in">Get-AzureRmContext</span></span><br></pre></td></tr></table></figure><h2 id="List-Available-Subscription"><a href="#List-Available-Subscription" class="headerlink" title="List Available Subscription."></a>List Available Subscription.</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># azure CLI</span></span><br><span class="line">az account list</span><br><span class="line"></span><br><span class="line"><span class="comment"># powershell</span></span><br><span class="line"><span class="built_in">Get-AzureRmContext</span> <span class="literal">-ListAvailable</span></span><br></pre></td></tr></table></figure><h3 id="Related-Posts"><a href="#Related-Posts" class="headerlink" title="Related Posts"></a>Related Posts</h3>]]></content:encoded>
      
      
      <category domain="https://yy1111yang.github.io/categories/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/categories/Azure/Powershell/">Powershell</category>
      
      
      <category domain="https://yy1111yang.github.io/tags/Cloud/">Cloud</category>
      
      <category domain="https://yy1111yang.github.io/tags/Azure/">Azure</category>
      
      <category domain="https://yy1111yang.github.io/tags/Powershell/">Powershell</category>
      
      <category domain="https://yy1111yang.github.io/tags/Subscription/">Subscription</category>
      
      
      <comments>https://yy1111yang.github.io/2020/12/10/20201210-az-account-cli/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
